```nim
非ログイン 参照系アクセス
framework_middleware
  csrfCheck スルー
コントローラー
  コンストラクタ
    proc initLogin()
      token = ""
      let session = db.queryOne(equal("token", token))
      if session == nil:
        return Login(isLogin: false)
  アクションメソッド index show
  View


非ログイン ログインページアクセス
framework_middleware
  csrfCheck getだからスルー
コントローラー
  コンストラクタ
    proc initLogin()
      token = ""
      let session = db.queryOne(equal("token", token))
      if session == nil:
        return Login(isLogin: false)
  アクションメソッド create
  View
    proc csrfToken(login)
      ログインしてない
      randomize()
      let token = rundStr().secureHash()
      var db = newFlatDb("session.db", false)
      discard db.load()
      db.append(%*{
        "token": $token, "login_at": $(getTime().toUnix())
      })
      return &"""<input type="hidden" name="_token" value="{token}">"""

非ログイン ログインpost
framework_middleware
  csrfCheck
    リクエストパラメータに_tokenあり
    セッションDBにtokenと一致
    タイムアウトチェック
    if not session.hasKey("uid"):
      セッションDBのlogin_atを更新
```